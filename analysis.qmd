---
title: "Analysis"
author: "Tanish Thaker"
format: html
execute: 
  echo: false
---

```{r}
#| message: false
#| label: setup

library(tidyverse)
library(primer.data)
library(brms)
library(tidybayes)
```

```{r}
star <- read_csv("data/STAR.csv")
```

```{r}
x <- star |>
  mutate(kinder = factor(classtype, 
                         levels = c(1, 2, 3), 
                         labels = c("small", "regular", "regular with aid")),
         race = factor(race, 
                       levels = c(1, 2, 3, 4, 5, 6), 
                       labels = c("white", "black", "asian", "hispanic", "native_american", "others")),
         race = fct_collapse(race,
                             others = c("asian", "native_american", "others")))
```

```{r}
x <- x |>
  select(kinder, race, g4math) |>
  drop_na(g4math) |>
  filter(kinder != "regular with aid")
```

```{r}
#| cache: true

fit_cs <- brm(formula = g4math ~ kinder,
                 data = x,
                 family = gaussian(),
                 refresh = 0,
                 silent = 2,
                 seed = 9)
fit_cs
```

```{r}
pp_check(fit_cs)
```

```{r}
ndata <- tibble(kinder = c("small", "regular"))

newstar <- fit_cs|>
  add_epred_draws(newdata = ndata) 
newstar

newstar |>
ggplot(aes(x = .epred, fill = as.factor(kinder))) +
  geom_density(alpha = 0.5) +
  theme(aspect.ratio = 0.5) +
  labs(title = "Posterior for Exam Score",
       subtitle = "Class size has no effect on exam score",
       x = "Exam Score",
       fill = "Classroom Size") +
  theme_minimal()
```

```{r}
newstar |> pivot_wider(id_cols = .draw, names_from = kinder, values_from = .epred) |> 
  mutate(causal_effect = small - regular) |> 
  ggplot(aes(x = causal_effect)) +
    geom_density() +
    labs(
      title = "Posterior for the Causal Effect of Fewer Students",
      subtitle = "Classes with fewer students do not have higher scores",
      x = "Expected Difference in Exam Scores") +
    theme(aspect.ratio = 0.25,
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank())
```

Formula: $$ score_i = \beta_0 + \beta_1 class\_size $$

Question: How does class size in K-4 school classes affect student performances? (Causal Affect)

Quantity of Interest: Student Scores

Preceptor Table: 
Units- Each Student
Outcome- g4math
Covariate- YearsSmall, classtype
Treatment- Different Class Size

Population Table: 
Time- Year

4 Key Assumptions with one counter for each:
Validity- Math scores calculated differently across schools in the US
Stability- Education System is different in diffferent schools and times
Unconfoundedness- Schools selected are schools in districts that have better grades
Representativeness- Only data in Tenessee which doesn't represent the US

